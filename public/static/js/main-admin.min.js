"use strict";

var $ = window.jQuery;
$(document).ready(function () {
    //$("pre").addClass("brush: js");
    //SyntaxHighlighter.all();
    //$("select.buscador").select2();
    /*$(".switch").bootstrapSwitch({
        onText:'SI',
        offText:'NO',
        handleWidth:40
    });
    $("[name='state']").bootstrapSwitch();
    $("[name='watermark']").bootstrapSwitch({‚àè
        onText:'SI',
        offText:'NO',
        labelText:'Marca de agua',
        labelWidth:100
    });
    $('input[type="date"]').datepicker({
        format: "yyyy-mm-dd",
        clearBtn: true,
        language: "es",
        autoclose: true,
        todayHighlight: true
    });*/
});
var App = {
    initialize: function initialize() {
        $("[data-autoclose]").delay(4000).slideUp(200, function () {
            $(this).alert('close');
        });
        $("#inputBrand").fileinput({
            theme: 'fa',
            allowedFileExtensions: ["jpg", "jpeg", "png", "gif", "svg"],
            previewSettings: { image: { width: "100%", height: "auto" } },
            showUpload: false,
            language: 'es',
            maxFileSize: 1000,
            uploadAsync: true,
            showCaption: true,
            minFileCount: 1
        });
        $("#imageBranchOffice").fileinput({
            theme: 'fa',
            allowedFileExtensions: ["jpg", "jpeg", "png", "gif", "svg"],
            previewSettings: { image: { width: "100%", height: "auto" } },
            showUpload: false,
            language: 'es',
            maxFileSize: 1000,
            uploadAsync: true,
            showCaption: true,
            minFileCount: 1,
            maxFileCount: 1
        });
        $("#inputLogo").fileinput({
            allowedFileExtensions: ["png", "gif", "svg"],
            previewSettings: { image: { width: "100%", height: "auto" } },
            language: "es",
            maxFileSize: 1000,
            uploadAsync: true,
            showUpload: true,
            showCaption: false
        });
        $("#product-image").fileinput({
            theme: "fa",
            allowedFileExtensions: ["jpg", "jpeg", "png", "gif", "svg"],
            language: "es",
            dropZoneEnabled: false,
            uploadAsync: false,
            minFileCount: 1,
            maxFileCount: 10,
            maxFileSize: 1000
        });
        $("#inputBanner").fileinput({
            theme: 'fa',
            allowedFileExtensions: ["jpg", "jpeg", "png", "gif"],
            previewSettings: { image: { width: "100%", height: "auto" } },
            language: "es",
            maxFileSize: 1000,
            uploadAsync: false,
            showCaption: true,
            showUpload: false
        });
        if (typeof jQuery.fn.redactor === 'function') {
            this.editor();
        }
        this.filterTable();
        $('[data-toggle="tooltip"]').tooltip();
        $('FormBrand').on('submit', function () {
            App.Brand.Form(this);
        });
        $('FormProduct').on('submit', function () {
            App.Product.Form(this);
        });
        $('#FormImagesProduct').on('submit', App.Product.FormImage);
        $("[data-delete-image]").on('click', function () {
            App.GalleryImageTrash(this);
        });
        $('#formBanner').submit(this.General.Banner.upload);
        $('.delete-banner').click(this.General.Banner.delete);
        // Categories
        $('.addCategory').on('click', this.Category.Create);
        $('.editCategory').on('click', this.Category.Update);
        $('.removeCategory').on('click', this.Category.Delete);
        //Stocks
        $('.quantity_stock').on('change', function (event) {
            event.preventDefault();
            var tableStock = $('#tableStock');
            tableStock.addClass('table-loading');
            var quantity = event.target.value;
            var id = event.target.dataset.id;

            var url = '/stocks/update';
            var data = { id: id, quantity: quantity };

            fetch(url, {
                method: 'PUT', // or 'PUT'
                body: JSON.stringify(data), // data can be `string` or {object}!
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(function (res) {
                return res.json();
            }).catch(function (error) {
                console.error('Error:', error);
                tableStock.removeClass('table-loading');
            }).then(function (response) {
                tableStock.removeClass('table-loading');
                bootbox.alert(response.message);
            });
        });
        $('.select-search').select2({
            language: "es",
            theme: "bootstrap"
        });
    },
    Brand: {
        Form: function Form(event, form) {
            event.preventDefault();
            App.loading();
            App.Post(form, function (data) {
                console.log(data);
                bootbox.alert(data.message, function () {
                    if (data.state) {
                        form.reset();
                        window.location = '/brands';
                    }
                });
            });
        }
    },
    Product: {
        Form: function Form() {
            event.preventDefault();
            App.loading();
            var form = this;
            App.Post(form, function (data) {
                bootbox.alert(data.message, function () {
                    if (data.state) {
                        form.reset();
                        window.location = '/products/admin';
                    }
                });
            });
        },
        FormImage: function FormImage() {
            event.preventDefault();
            var form = this;
            App.loading();
            var formData = new FormData(form);
            fetch(form.action, {
                method: form.method,
                body: formData
            }).then(function (response) {
                return response.json();
            }).catch(function (error) {
                return console.error('Error:', error);
            }).then(function (response) {
                return App.Render('product-image.hbs', function (template) {
                    var templateRender = template(response.images);
                    $('#ProductImages').append(templateRender);
                    $("[data-delete-image]").on('click', function () {
                        App.GalleryImageTrash(this);
                    });
                    form.reset();
                });
            });
            App.loadingHide();
        }
    },
    Category: {
        Create: function Create(event) {
            event.preventDefault();
            var id = $(this).data('id');
            bootbox.prompt({
                title: "Ingrese el nombre de la nueva categoria.",
                buttons: {
                    confirm: {
                        label: 'Guardar',
                        className: 'btn-primary'
                    },
                    cancel: {
                        label: 'Cancelar',
                        className: 'btn-default'
                    }
                },
                callback: function callback(name) {
                    if (id && name) {
                        $.post("/categories", { father_id: id, name: name }, function (data) {
                            var item = "<li class=\"list-group-item\">" + data.category.name + " <button type=\"button\" data-id=\"" + data.category.hashid + "\" data-name=\"" + data.category.name + "\" class=\"editCategory btn btn-default btn-xs\"> <i class=\"fa fa-edit\"></i></button> <button type=\"button\" data-id=\"" + data.category.hashid + "\" class=\"addCategory btn btn-default btn-xs\"><i class=\"fa fa-plus\"></i></button> <button type=\"button\" data-id=\"" + data.category.hashid + "\" class=\"removeCategory btn btn-default btn-xs\"><i class=\"fa fa-trash\"></i></button></li>";
                            $("#" + id).append(item);
                            console.log(data);
                        });
                    }
                }
            });
        },
        Update: function Update(event) {
            event.preventDefault();
            var item = $(this);
            var id = item.data('id');
            var name = item.data('name');
            bootbox.prompt({
                title: "Ingrese el nombre de la nueva categoria.",
                value: name,
                buttons: {
                    confirm: {
                        label: 'Guardar',
                        className: 'btn-primary'
                    },
                    cancel: {
                        label: 'Cancelar',
                        className: 'btn-default'
                    }
                },
                callback: function callback(result) {
                    if (result) {
                        var dataObject = { 'id': id, 'name': result };
                        $.ajax({
                            url: '/categories/',
                            type: 'PUT',
                            data: JSON.stringify(dataObject),
                            success: function success(data) {
                                bootbox.alert(data.message, function () {
                                    if (data.state) {
                                        $("#" + id + " > .item > span").text(result);
                                        $("#" + id + " > .item > .btn-group > .editCategory").data('name', result);
                                    }
                                });
                            }
                        });
                    }
                }
            });
        }
    },
    Post: function Post(form, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open(form.method, form.action, true);
        xhr.onload = function (e) {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var res = xhr.responseText;
                    callback(JSON.parse(res));
                } else {
                    console.error(xhr.statusText);
                }
            }
        };
        xhr.onerror = function (e) {
            console.error(xhr.statusText);
        };
        xhr.send(new FormData(form));
    },
    getJSON: function getJSON(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', url, true);
        xhr.onload = function (e) {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    var res = xhr.responseText;
                    callback(JSON.parse(res));
                } else {
                    console.error(xhr.statusText);
                }
            }
        };
        xhr.onerror = function (e) {
            console.error(xhr.statusText);
        };
        xhr.send(null);
    },
    loading: function loading() {
        document.getElementById('loading').style.display = 'block';
    },
    loadingHide: function loadingHide() {
        document.getElementById('loading').style.display = 'none';
    },
    formPost: function formPost(evt, form) {
        evt.preventDefault();
        $('#loading').show();
        var url = form.action;
        var postUrl = form.dataset.posturl;
        var dataSerialize = $(form).serialize();

        if (typeof postUrl === 'undefined') {
            postUrl = window.location.pathname;
        }
        $.post(url, dataSerialize, function (data) {
            console.log(data);
            $("#loading").hide();
            bootbox.alert(data.message, function () {
                if (data.state) {
                    App.ir(postUrl);
                }
            });
        });
    },
    formDataPost: function formDataPost(form) {
        console.log(form);
        var url = form.action;
        //var postUrl = form.dataset.posturl?:null;
        var data = new FormData(form);
        //if(typeof postUrl === 'undefined'){
        var postUrl = window.location.pathname;
        //}
        $.ajax({
            url: url,
            data: data,
            cache: false,
            contentType: false,
            processData: false,
            type: 'POST',
            success: function success(data) {
                console.log(data);
                App.loadingHide();
                bootbox.alert(data.message, function () {
                    if (data.state) {
                        App.ir(postUrl);
                    }
                });
            }
        });
    },
    GalleryImageTrash: function GalleryImageTrash(item) {
        bootbox.confirm({
            message: "Esta seguro(a) de eliminar esta imagen",
            callback: function callback(resp) {
                if (resp) {
                    App.loading();
                    var id = item.dataset.id;
                    var image = item.parentNode.parentNode.parentNode.parentNode;
                    $.getJSON('/products/delete-image/' + id, function (result) {
                        console.log(result);
                        App.loadingHide();
                        bootbox.alert(result.message);
                        if (result.state) {
                            image.remove();
                        }
                    });
                }
                App.loadingHide();
            }
        });
    },
    ir: function ir(url) {
        window.location = url;
    },
    template: function template(path, target, jsonData) {
        var source;
        var template;
        $.ajax({
            url: path,
            cache: false,
            success: function success(data) {
                source = data;
                template = Handlebars.compile(source);
                $(target).html(template(jsonData));
            }
        });
    },
    editor: function editor() {
        $('.editor').redactor({
            imageUpload: '/upload/image',
            fileUpload: '/upload/document',
            imageManagerJson: '/upload/read',
            replaceDivs: false,
            buttonSource: true,
            lang: 'es',
            plugins: ['underline', 'video', 'fontcolor', 'imagemanager', 'table', 'fontsize', 'fullscreen'],
            formatting: ['p', 'blockquote', 'pre', 'h1', 'h2', 'h3', 'h4', 'h5'],
            formattingAdd: {
                "accordion-header": {
                    title: 'Titulo Accordion',
                    args: ['h3', 'class', 'accordion-titulo', 'toggle']
                }
            }
        });
    },
    filterTable: function filterTable() {
        $('.table-filter').DataTable({
            "language": {
                "lengthMenu": "Mostrar _MENU_ registros por p√°gina",
                "zeroRecords": "No existen registros",
                "info": "Mostrando la p√°gina _PAGE_ de _PAGES_",
                "infoEmpty": "No hay registros disponibles",
                "search": "Buscar:",
                "infoFiltered": "(con filtro de _MAX_ registros en total)",
                "paginate": {
                    "first": "Primero",
                    "last": "√öltimo",
                    "next": "Siguiente",
                    "previous": "Anterior"
                }
            }
        });
    },
    General: {
        Banner: {
            upload: function upload() {
                event.preventDefault();
                App.loading();
                var form = this;
                var xhr = new XMLHttpRequest();
                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        var data = JSON.parse(xhr.response);
                        App.Render('Banners.hbs', function (template) {
                            document.getElementById('sliders').innerHTML = template(data.banners);
                            var deleteBanner = document.querySelectorAll('.delete-banner');
                            for (var bnr = 0; bnr < deleteBanner.length; bnr++) {
                                deleteBanner[bnr].addEventListener('click', App.General.Banner.delete, false);
                            }
                        });
                        form.reset();
                        App.loadingHide();
                        bootbox.alert(data.message);
                    } else {
                        console.error("Error de request");
                    }
                };
                xhr.open(form.method, form.action, true);
                xhr.send(new FormData(form));
                return false;
            },
            delete: function _delete() {
                event.preventDefault();
                var slide = this;
                var id = slide.dataset.id;
                bootbox.confirm({
                    size: 'small',
                    message: "Esta seguro(a) de eliminar este banner",
                    callback: function callback(resp) {
                        App.loading();
                        if (resp) {
                            App.getJSON("/general/delete-banner/" + id, function (result) {
                                if (result.state) {
                                    var slider = slide.parentNode.parentNode.parentNode.parentNode.parentNode;
                                    slider.parentNode.removeChild(slider);
                                }
                                App.loadingHide();
                                bootbox.alert(result.message);
                            });
                        }
                    }
                });
            }
        }
    },
    Render: function Render(tpl, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open('GET', "/App/Resource/Views/templates/" + tpl, true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState == 4 && xhr.status == 200) {
                var raw = xhr.responseText;
                var compiled = Handlebars.compile(raw);
                callback(compiled);
            }
        };
        xhr.send();
    }

};
(function ($) {
    $.fn.replaceClass = function (pFromClass, pToClass) {
        return this.removeClass(pFromClass).addClass(pToClass);
    };
})(jQuery);
window.onload = App.initialize();
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIiwic291cmNlcyI6WyJtYWluLWFkbWluLm1pbi5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJcInVzZSBzdHJpY3RcIjtcblxudmFyICQgPSB3aW5kb3cualF1ZXJ5O1xuJChkb2N1bWVudCkucmVhZHkoZnVuY3Rpb24gKCkge1xuICAgIC8vJChcInByZVwiKS5hZGRDbGFzcyhcImJydXNoOiBqc1wiKTtcbiAgICAvL1N5bnRheEhpZ2hsaWdodGVyLmFsbCgpO1xuICAgIC8vJChcInNlbGVjdC5idXNjYWRvclwiKS5zZWxlY3QyKCk7XG4gICAgLyokKFwiLnN3aXRjaFwiKS5ib290c3RyYXBTd2l0Y2goe1xuICAgICAgICBvblRleHQ6J1NJJyxcbiAgICAgICAgb2ZmVGV4dDonTk8nLFxuICAgICAgICBoYW5kbGVXaWR0aDo0MFxuICAgIH0pO1xuICAgICQoXCJbbmFtZT0nc3RhdGUnXVwiKS5ib290c3RyYXBTd2l0Y2goKTtcbiAgICAkKFwiW25hbWU9J3dhdGVybWFyayddXCIpLmJvb3RzdHJhcFN3aXRjaCh74oiPXG4gICAgICAgIG9uVGV4dDonU0knLFxuICAgICAgICBvZmZUZXh0OidOTycsXG4gICAgICAgIGxhYmVsVGV4dDonTWFyY2EgZGUgYWd1YScsXG4gICAgICAgIGxhYmVsV2lkdGg6MTAwXG4gICAgfSk7XG4gICAgJCgnaW5wdXRbdHlwZT1cImRhdGVcIl0nKS5kYXRlcGlja2VyKHtcbiAgICAgICAgZm9ybWF0OiBcInl5eXktbW0tZGRcIixcbiAgICAgICAgY2xlYXJCdG46IHRydWUsXG4gICAgICAgIGxhbmd1YWdlOiBcImVzXCIsXG4gICAgICAgIGF1dG9jbG9zZTogdHJ1ZSxcbiAgICAgICAgdG9kYXlIaWdobGlnaHQ6IHRydWVcbiAgICB9KTsqL1xufSk7XG52YXIgQXBwID0ge1xuICAgIGluaXRpYWxpemU6IGZ1bmN0aW9uIGluaXRpYWxpemUoKSB7XG4gICAgICAgICQoXCJbZGF0YS1hdXRvY2xvc2VdXCIpLmRlbGF5KDQwMDApLnNsaWRlVXAoMjAwLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAkKHRoaXMpLmFsZXJ0KCdjbG9zZScpO1xuICAgICAgICB9KTtcbiAgICAgICAgJChcIiNpbnB1dEJyYW5kXCIpLmZpbGVpbnB1dCh7XG4gICAgICAgICAgICB0aGVtZTogJ2ZhJyxcbiAgICAgICAgICAgIGFsbG93ZWRGaWxlRXh0ZW5zaW9uczogW1wianBnXCIsIFwianBlZ1wiLCBcInBuZ1wiLCBcImdpZlwiLCBcInN2Z1wiXSxcbiAgICAgICAgICAgIHByZXZpZXdTZXR0aW5nczogeyBpbWFnZTogeyB3aWR0aDogXCIxMDAlXCIsIGhlaWdodDogXCJhdXRvXCIgfSB9LFxuICAgICAgICAgICAgc2hvd1VwbG9hZDogZmFsc2UsXG4gICAgICAgICAgICBsYW5ndWFnZTogJ2VzJyxcbiAgICAgICAgICAgIG1heEZpbGVTaXplOiAxMDAwLFxuICAgICAgICAgICAgdXBsb2FkQXN5bmM6IHRydWUsXG4gICAgICAgICAgICBzaG93Q2FwdGlvbjogdHJ1ZSxcbiAgICAgICAgICAgIG1pbkZpbGVDb3VudDogMVxuICAgICAgICB9KTtcbiAgICAgICAgJChcIiNpbWFnZUJyYW5jaE9mZmljZVwiKS5maWxlaW5wdXQoe1xuICAgICAgICAgICAgdGhlbWU6ICdmYScsXG4gICAgICAgICAgICBhbGxvd2VkRmlsZUV4dGVuc2lvbnM6IFtcImpwZ1wiLCBcImpwZWdcIiwgXCJwbmdcIiwgXCJnaWZcIiwgXCJzdmdcIl0sXG4gICAgICAgICAgICBwcmV2aWV3U2V0dGluZ3M6IHsgaW1hZ2U6IHsgd2lkdGg6IFwiMTAwJVwiLCBoZWlnaHQ6IFwiYXV0b1wiIH0gfSxcbiAgICAgICAgICAgIHNob3dVcGxvYWQ6IGZhbHNlLFxuICAgICAgICAgICAgbGFuZ3VhZ2U6ICdlcycsXG4gICAgICAgICAgICBtYXhGaWxlU2l6ZTogMTAwMCxcbiAgICAgICAgICAgIHVwbG9hZEFzeW5jOiB0cnVlLFxuICAgICAgICAgICAgc2hvd0NhcHRpb246IHRydWUsXG4gICAgICAgICAgICBtaW5GaWxlQ291bnQ6IDEsXG4gICAgICAgICAgICBtYXhGaWxlQ291bnQ6IDFcbiAgICAgICAgfSk7XG4gICAgICAgICQoXCIjaW5wdXRMb2dvXCIpLmZpbGVpbnB1dCh7XG4gICAgICAgICAgICBhbGxvd2VkRmlsZUV4dGVuc2lvbnM6IFtcInBuZ1wiLCBcImdpZlwiLCBcInN2Z1wiXSxcbiAgICAgICAgICAgIHByZXZpZXdTZXR0aW5nczogeyBpbWFnZTogeyB3aWR0aDogXCIxMDAlXCIsIGhlaWdodDogXCJhdXRvXCIgfSB9LFxuICAgICAgICAgICAgbGFuZ3VhZ2U6IFwiZXNcIixcbiAgICAgICAgICAgIG1heEZpbGVTaXplOiAxMDAwLFxuICAgICAgICAgICAgdXBsb2FkQXN5bmM6IHRydWUsXG4gICAgICAgICAgICBzaG93VXBsb2FkOiB0cnVlLFxuICAgICAgICAgICAgc2hvd0NhcHRpb246IGZhbHNlXG4gICAgICAgIH0pO1xuICAgICAgICAkKFwiI3Byb2R1Y3QtaW1hZ2VcIikuZmlsZWlucHV0KHtcbiAgICAgICAgICAgIHRoZW1lOiBcImZhXCIsXG4gICAgICAgICAgICBhbGxvd2VkRmlsZUV4dGVuc2lvbnM6IFtcImpwZ1wiLCBcImpwZWdcIiwgXCJwbmdcIiwgXCJnaWZcIiwgXCJzdmdcIl0sXG4gICAgICAgICAgICBsYW5ndWFnZTogXCJlc1wiLFxuICAgICAgICAgICAgZHJvcFpvbmVFbmFibGVkOiBmYWxzZSxcbiAgICAgICAgICAgIHVwbG9hZEFzeW5jOiBmYWxzZSxcbiAgICAgICAgICAgIG1pbkZpbGVDb3VudDogMSxcbiAgICAgICAgICAgIG1heEZpbGVDb3VudDogMTAsXG4gICAgICAgICAgICBtYXhGaWxlU2l6ZTogMTAwMFxuICAgICAgICB9KTtcbiAgICAgICAgJChcIiNpbnB1dEJhbm5lclwiKS5maWxlaW5wdXQoe1xuICAgICAgICAgICAgdGhlbWU6ICdmYScsXG4gICAgICAgICAgICBhbGxvd2VkRmlsZUV4dGVuc2lvbnM6IFtcImpwZ1wiLCBcImpwZWdcIiwgXCJwbmdcIiwgXCJnaWZcIl0sXG4gICAgICAgICAgICBwcmV2aWV3U2V0dGluZ3M6IHsgaW1hZ2U6IHsgd2lkdGg6IFwiMTAwJVwiLCBoZWlnaHQ6IFwiYXV0b1wiIH0gfSxcbiAgICAgICAgICAgIGxhbmd1YWdlOiBcImVzXCIsXG4gICAgICAgICAgICBtYXhGaWxlU2l6ZTogMTAwMCxcbiAgICAgICAgICAgIHVwbG9hZEFzeW5jOiBmYWxzZSxcbiAgICAgICAgICAgIHNob3dDYXB0aW9uOiB0cnVlLFxuICAgICAgICAgICAgc2hvd1VwbG9hZDogZmFsc2VcbiAgICAgICAgfSk7XG4gICAgICAgIGlmICh0eXBlb2YgalF1ZXJ5LmZuLnJlZGFjdG9yID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgICAgICB0aGlzLmVkaXRvcigpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuZmlsdGVyVGFibGUoKTtcbiAgICAgICAgJCgnW2RhdGEtdG9nZ2xlPVwidG9vbHRpcFwiXScpLnRvb2x0aXAoKTtcbiAgICAgICAgJCgnRm9ybUJyYW5kJykub24oJ3N1Ym1pdCcsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIEFwcC5CcmFuZC5Gb3JtKHRoaXMpO1xuICAgICAgICB9KTtcbiAgICAgICAgJCgnRm9ybVByb2R1Y3QnKS5vbignc3VibWl0JywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgQXBwLlByb2R1Y3QuRm9ybSh0aGlzKTtcbiAgICAgICAgfSk7XG4gICAgICAgICQoJyNGb3JtSW1hZ2VzUHJvZHVjdCcpLm9uKCdzdWJtaXQnLCBBcHAuUHJvZHVjdC5Gb3JtSW1hZ2UpO1xuICAgICAgICAkKFwiW2RhdGEtZGVsZXRlLWltYWdlXVwiKS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBBcHAuR2FsbGVyeUltYWdlVHJhc2godGhpcyk7XG4gICAgICAgIH0pO1xuICAgICAgICAkKCcjZm9ybUJhbm5lcicpLnN1Ym1pdCh0aGlzLkdlbmVyYWwuQmFubmVyLnVwbG9hZCk7XG4gICAgICAgICQoJy5kZWxldGUtYmFubmVyJykuY2xpY2sodGhpcy5HZW5lcmFsLkJhbm5lci5kZWxldGUpO1xuICAgICAgICAvLyBDYXRlZ29yaWVzXG4gICAgICAgICQoJy5hZGRDYXRlZ29yeScpLm9uKCdjbGljaycsIHRoaXMuQ2F0ZWdvcnkuQ3JlYXRlKTtcbiAgICAgICAgJCgnLmVkaXRDYXRlZ29yeScpLm9uKCdjbGljaycsIHRoaXMuQ2F0ZWdvcnkuVXBkYXRlKTtcbiAgICAgICAgJCgnLnJlbW92ZUNhdGVnb3J5Jykub24oJ2NsaWNrJywgdGhpcy5DYXRlZ29yeS5EZWxldGUpO1xuICAgICAgICAvL1N0b2Nrc1xuICAgICAgICAkKCcucXVhbnRpdHlfc3RvY2snKS5vbignY2hhbmdlJywgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgdmFyIHRhYmxlU3RvY2sgPSAkKCcjdGFibGVTdG9jaycpO1xuICAgICAgICAgICAgdGFibGVTdG9jay5hZGRDbGFzcygndGFibGUtbG9hZGluZycpO1xuICAgICAgICAgICAgdmFyIHF1YW50aXR5ID0gZXZlbnQudGFyZ2V0LnZhbHVlO1xuICAgICAgICAgICAgdmFyIGlkID0gZXZlbnQudGFyZ2V0LmRhdGFzZXQuaWQ7XG5cbiAgICAgICAgICAgIHZhciB1cmwgPSAnL3N0b2Nrcy91cGRhdGUnO1xuICAgICAgICAgICAgdmFyIGRhdGEgPSB7IGlkOiBpZCwgcXVhbnRpdHk6IHF1YW50aXR5IH07XG5cbiAgICAgICAgICAgIGZldGNoKHVybCwge1xuICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BVVCcsIC8vIG9yICdQVVQnXG4gICAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoZGF0YSksIC8vIGRhdGEgY2FuIGJlIGBzdHJpbmdgIG9yIHtvYmplY3R9IVxuICAgICAgICAgICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAgICAgICAgICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJ1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlcykge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXMuanNvbigpO1xuICAgICAgICAgICAgfSkuY2F0Y2goZnVuY3Rpb24gKGVycm9yKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgICAgICAgICAgICAgIHRhYmxlU3RvY2sucmVtb3ZlQ2xhc3MoJ3RhYmxlLWxvYWRpbmcnKTtcbiAgICAgICAgICAgIH0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7XG4gICAgICAgICAgICAgICAgdGFibGVTdG9jay5yZW1vdmVDbGFzcygndGFibGUtbG9hZGluZycpO1xuICAgICAgICAgICAgICAgIGJvb3Rib3guYWxlcnQocmVzcG9uc2UubWVzc2FnZSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgICQoJy5zZWxlY3Qtc2VhcmNoJykuc2VsZWN0Mih7XG4gICAgICAgICAgICBsYW5ndWFnZTogXCJlc1wiLFxuICAgICAgICAgICAgdGhlbWU6IFwiYm9vdHN0cmFwXCJcbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBCcmFuZDoge1xuICAgICAgICBGb3JtOiBmdW5jdGlvbiBGb3JtKGV2ZW50LCBmb3JtKSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgQXBwLmxvYWRpbmcoKTtcbiAgICAgICAgICAgIEFwcC5Qb3N0KGZvcm0sIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgICAgICAgICAgYm9vdGJveC5hbGVydChkYXRhLm1lc3NhZ2UsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuc3RhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm0ucmVzZXQoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9ICcvYnJhbmRzJztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIFByb2R1Y3Q6IHtcbiAgICAgICAgRm9ybTogZnVuY3Rpb24gRm9ybSgpIHtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICBBcHAubG9hZGluZygpO1xuICAgICAgICAgICAgdmFyIGZvcm0gPSB0aGlzO1xuICAgICAgICAgICAgQXBwLlBvc3QoZm9ybSwgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgICAgICAgICAgICBib290Ym94LmFsZXJ0KGRhdGEubWVzc2FnZSwgZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5zdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgZm9ybS5yZXNldCgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgd2luZG93LmxvY2F0aW9uID0gJy9wcm9kdWN0cy9hZG1pbic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9LFxuICAgICAgICBGb3JtSW1hZ2U6IGZ1bmN0aW9uIEZvcm1JbWFnZSgpIHtcbiAgICAgICAgICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgICAgICAgICB2YXIgZm9ybSA9IHRoaXM7XG4gICAgICAgICAgICBBcHAubG9hZGluZygpO1xuICAgICAgICAgICAgdmFyIGZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKGZvcm0pO1xuICAgICAgICAgICAgZmV0Y2goZm9ybS5hY3Rpb24sIHtcbiAgICAgICAgICAgICAgICBtZXRob2Q6IGZvcm0ubWV0aG9kLFxuICAgICAgICAgICAgICAgIGJvZHk6IGZvcm1EYXRhXG4gICAgICAgICAgICB9KS50aGVuKGZ1bmN0aW9uIChyZXNwb25zZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZXJyb3IpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gY29uc29sZS5lcnJvcignRXJyb3I6JywgZXJyb3IpO1xuICAgICAgICAgICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2UpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gQXBwLlJlbmRlcigncHJvZHVjdC1pbWFnZS5oYnMnLCBmdW5jdGlvbiAodGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRlbXBsYXRlUmVuZGVyID0gdGVtcGxhdGUocmVzcG9uc2UuaW1hZ2VzKTtcbiAgICAgICAgICAgICAgICAgICAgJCgnI1Byb2R1Y3RJbWFnZXMnKS5hcHBlbmQodGVtcGxhdGVSZW5kZXIpO1xuICAgICAgICAgICAgICAgICAgICAkKFwiW2RhdGEtZGVsZXRlLWltYWdlXVwiKS5vbignY2xpY2snLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBBcHAuR2FsbGVyeUltYWdlVHJhc2godGhpcyk7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICBmb3JtLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIEFwcC5sb2FkaW5nSGlkZSgpO1xuICAgICAgICB9XG4gICAgfSxcbiAgICBDYXRlZ29yeToge1xuICAgICAgICBDcmVhdGU6IGZ1bmN0aW9uIENyZWF0ZShldmVudCkge1xuICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgIHZhciBpZCA9ICQodGhpcykuZGF0YSgnaWQnKTtcbiAgICAgICAgICAgIGJvb3Rib3gucHJvbXB0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogXCJJbmdyZXNlIGVsIG5vbWJyZSBkZSBsYSBudWV2YSBjYXRlZ29yaWEuXCIsXG4gICAgICAgICAgICAgICAgYnV0dG9uczoge1xuICAgICAgICAgICAgICAgICAgICBjb25maXJtOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ0d1YXJkYXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnYnRuLXByaW1hcnknXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGNhbmNlbDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICdDYW5jZWxhcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICdidG4tZGVmYXVsdCdcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIGNhbGxiYWNrKG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGlkICYmIG5hbWUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICQucG9zdChcIi9jYXRlZ29yaWVzXCIsIHsgZmF0aGVyX2lkOiBpZCwgbmFtZTogbmFtZSB9LCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpdGVtID0gXCI8bGkgY2xhc3M9XFxcImxpc3QtZ3JvdXAtaXRlbVxcXCI+XCIgKyBkYXRhLmNhdGVnb3J5Lm5hbWUgKyBcIiA8YnV0dG9uIHR5cGU9XFxcImJ1dHRvblxcXCIgZGF0YS1pZD1cXFwiXCIgKyBkYXRhLmNhdGVnb3J5Lmhhc2hpZCArIFwiXFxcIiBkYXRhLW5hbWU9XFxcIlwiICsgZGF0YS5jYXRlZ29yeS5uYW1lICsgXCJcXFwiIGNsYXNzPVxcXCJlZGl0Q2F0ZWdvcnkgYnRuIGJ0bi1kZWZhdWx0IGJ0bi14c1xcXCI+IDxpIGNsYXNzPVxcXCJmYSBmYS1lZGl0XFxcIj48L2k+PC9idXR0b24+IDxidXR0b24gdHlwZT1cXFwiYnV0dG9uXFxcIiBkYXRhLWlkPVxcXCJcIiArIGRhdGEuY2F0ZWdvcnkuaGFzaGlkICsgXCJcXFwiIGNsYXNzPVxcXCJhZGRDYXRlZ29yeSBidG4gYnRuLWRlZmF1bHQgYnRuLXhzXFxcIj48aSBjbGFzcz1cXFwiZmEgZmEtcGx1c1xcXCI+PC9pPjwvYnV0dG9uPiA8YnV0dG9uIHR5cGU9XFxcImJ1dHRvblxcXCIgZGF0YS1pZD1cXFwiXCIgKyBkYXRhLmNhdGVnb3J5Lmhhc2hpZCArIFwiXFxcIiBjbGFzcz1cXFwicmVtb3ZlQ2F0ZWdvcnkgYnRuIGJ0bi1kZWZhdWx0IGJ0bi14c1xcXCI+PGkgY2xhc3M9XFxcImZhIGZhLXRyYXNoXFxcIj48L2k+PC9idXR0b24+PC9saT5cIjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKFwiI1wiICsgaWQpLmFwcGVuZChpdGVtKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0sXG4gICAgICAgIFVwZGF0ZTogZnVuY3Rpb24gVXBkYXRlKGV2ZW50KSB7XG4gICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgdmFyIGl0ZW0gPSAkKHRoaXMpO1xuICAgICAgICAgICAgdmFyIGlkID0gaXRlbS5kYXRhKCdpZCcpO1xuICAgICAgICAgICAgdmFyIG5hbWUgPSBpdGVtLmRhdGEoJ25hbWUnKTtcbiAgICAgICAgICAgIGJvb3Rib3gucHJvbXB0KHtcbiAgICAgICAgICAgICAgICB0aXRsZTogXCJJbmdyZXNlIGVsIG5vbWJyZSBkZSBsYSBudWV2YSBjYXRlZ29yaWEuXCIsXG4gICAgICAgICAgICAgICAgdmFsdWU6IG5hbWUsXG4gICAgICAgICAgICAgICAgYnV0dG9uczoge1xuICAgICAgICAgICAgICAgICAgICBjb25maXJtOiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogJ0d1YXJkYXInLFxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiAnYnRuLXByaW1hcnknXG4gICAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICAgIGNhbmNlbDoge1xuICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6ICdDYW5jZWxhcicsXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGFzc05hbWU6ICdidG4tZGVmYXVsdCdcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIGNhbGxiYWNrKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZGF0YU9iamVjdCA9IHsgJ2lkJzogaWQsICduYW1lJzogcmVzdWx0IH07XG4gICAgICAgICAgICAgICAgICAgICAgICAkLmFqYXgoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogJy9jYXRlZ29yaWVzLycsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ1BVVCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YTogSlNPTi5zdHJpbmdpZnkoZGF0YU9iamVjdCksXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc3VjY2VzczogZnVuY3Rpb24gc3VjY2VzcyhkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJvb3Rib3guYWxlcnQoZGF0YS5tZXNzYWdlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5zdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICQoXCIjXCIgKyBpZCArIFwiID4gLml0ZW0gPiBzcGFuXCIpLnRleHQocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkKFwiI1wiICsgaWQgKyBcIiA+IC5pdGVtID4gLmJ0bi1ncm91cCA+IC5lZGl0Q2F0ZWdvcnlcIikuZGF0YSgnbmFtZScsIHJlc3VsdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIFBvc3Q6IGZ1bmN0aW9uIFBvc3QoZm9ybSwgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICB4aHIub3Blbihmb3JtLm1ldGhvZCwgZm9ybS5hY3Rpb24sIHRydWUpO1xuICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkge1xuICAgICAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IHhoci5yZXNwb25zZVRleHQ7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKEpTT04ucGFyc2UocmVzKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcih4aHIuc3RhdHVzVGV4dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB4aHIub25lcnJvciA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKHhoci5zdGF0dXNUZXh0KTtcbiAgICAgICAgfTtcbiAgICAgICAgeGhyLnNlbmQobmV3IEZvcm1EYXRhKGZvcm0pKTtcbiAgICB9LFxuICAgIGdldEpTT046IGZ1bmN0aW9uIGdldEpTT04odXJsLCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgIHhoci5vcGVuKCdHRVQnLCB1cmwsIHRydWUpO1xuICAgICAgICB4aHIub25sb2FkID0gZnVuY3Rpb24gKGUpIHtcbiAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PT0gNCkge1xuICAgICAgICAgICAgICAgIGlmICh4aHIuc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJlcyA9IHhoci5yZXNwb25zZVRleHQ7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKEpTT04ucGFyc2UocmVzKSk7XG4gICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcih4aHIuc3RhdHVzVGV4dCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB4aHIub25lcnJvciA9IGZ1bmN0aW9uIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKHhoci5zdGF0dXNUZXh0KTtcbiAgICAgICAgfTtcbiAgICAgICAgeGhyLnNlbmQobnVsbCk7XG4gICAgfSxcbiAgICBsb2FkaW5nOiBmdW5jdGlvbiBsb2FkaW5nKCkge1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZycpLnN0eWxlLmRpc3BsYXkgPSAnYmxvY2snO1xuICAgIH0sXG4gICAgbG9hZGluZ0hpZGU6IGZ1bmN0aW9uIGxvYWRpbmdIaWRlKCkge1xuICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9hZGluZycpLnN0eWxlLmRpc3BsYXkgPSAnbm9uZSc7XG4gICAgfSxcbiAgICBmb3JtUG9zdDogZnVuY3Rpb24gZm9ybVBvc3QoZXZ0LCBmb3JtKSB7XG4gICAgICAgIGV2dC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAkKCcjbG9hZGluZycpLnNob3coKTtcbiAgICAgICAgdmFyIHVybCA9IGZvcm0uYWN0aW9uO1xuICAgICAgICB2YXIgcG9zdFVybCA9IGZvcm0uZGF0YXNldC5wb3N0dXJsO1xuICAgICAgICB2YXIgZGF0YVNlcmlhbGl6ZSA9ICQoZm9ybSkuc2VyaWFsaXplKCk7XG5cbiAgICAgICAgaWYgKHR5cGVvZiBwb3N0VXJsID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgcG9zdFVybCA9IHdpbmRvdy5sb2NhdGlvbi5wYXRobmFtZTtcbiAgICAgICAgfVxuICAgICAgICAkLnBvc3QodXJsLCBkYXRhU2VyaWFsaXplLCBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coZGF0YSk7XG4gICAgICAgICAgICAkKFwiI2xvYWRpbmdcIikuaGlkZSgpO1xuICAgICAgICAgICAgYm9vdGJveC5hbGVydChkYXRhLm1lc3NhZ2UsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YS5zdGF0ZSkge1xuICAgICAgICAgICAgICAgICAgICBBcHAuaXIocG9zdFVybCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgIH0sXG4gICAgZm9ybURhdGFQb3N0OiBmdW5jdGlvbiBmb3JtRGF0YVBvc3QoZm9ybSkge1xuICAgICAgICBjb25zb2xlLmxvZyhmb3JtKTtcbiAgICAgICAgdmFyIHVybCA9IGZvcm0uYWN0aW9uO1xuICAgICAgICAvL3ZhciBwb3N0VXJsID0gZm9ybS5kYXRhc2V0LnBvc3R1cmw/Om51bGw7XG4gICAgICAgIHZhciBkYXRhID0gbmV3IEZvcm1EYXRhKGZvcm0pO1xuICAgICAgICAvL2lmKHR5cGVvZiBwb3N0VXJsID09PSAndW5kZWZpbmVkJyl7XG4gICAgICAgIHZhciBwb3N0VXJsID0gd2luZG93LmxvY2F0aW9uLnBhdGhuYW1lO1xuICAgICAgICAvL31cbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgIHVybDogdXJsLFxuICAgICAgICAgICAgZGF0YTogZGF0YSxcbiAgICAgICAgICAgIGNhY2hlOiBmYWxzZSxcbiAgICAgICAgICAgIGNvbnRlbnRUeXBlOiBmYWxzZSxcbiAgICAgICAgICAgIHByb2Nlc3NEYXRhOiBmYWxzZSxcbiAgICAgICAgICAgIHR5cGU6ICdQT1NUJyxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MoZGF0YSkge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGRhdGEpO1xuICAgICAgICAgICAgICAgIEFwcC5sb2FkaW5nSGlkZSgpO1xuICAgICAgICAgICAgICAgIGJvb3Rib3guYWxlcnQoZGF0YS5tZXNzYWdlLCBmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLnN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBBcHAuaXIocG9zdFVybCk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBHYWxsZXJ5SW1hZ2VUcmFzaDogZnVuY3Rpb24gR2FsbGVyeUltYWdlVHJhc2goaXRlbSkge1xuICAgICAgICBib290Ym94LmNvbmZpcm0oe1xuICAgICAgICAgICAgbWVzc2FnZTogXCJFc3RhIHNlZ3VybyhhKSBkZSBlbGltaW5hciBlc3RhIGltYWdlblwiLFxuICAgICAgICAgICAgY2FsbGJhY2s6IGZ1bmN0aW9uIGNhbGxiYWNrKHJlc3ApIHtcbiAgICAgICAgICAgICAgICBpZiAocmVzcCkge1xuICAgICAgICAgICAgICAgICAgICBBcHAubG9hZGluZygpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaWQgPSBpdGVtLmRhdGFzZXQuaWQ7XG4gICAgICAgICAgICAgICAgICAgIHZhciBpbWFnZSA9IGl0ZW0ucGFyZW50Tm9kZS5wYXJlbnROb2RlLnBhcmVudE5vZGUucGFyZW50Tm9kZTtcbiAgICAgICAgICAgICAgICAgICAgJC5nZXRKU09OKCcvcHJvZHVjdHMvZGVsZXRlLWltYWdlLycgKyBpZCwgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIEFwcC5sb2FkaW5nSGlkZSgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYm9vdGJveC5hbGVydChyZXN1bHQubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UucmVtb3ZlKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBBcHAubG9hZGluZ0hpZGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBpcjogZnVuY3Rpb24gaXIodXJsKSB7XG4gICAgICAgIHdpbmRvdy5sb2NhdGlvbiA9IHVybDtcbiAgICB9LFxuICAgIHRlbXBsYXRlOiBmdW5jdGlvbiB0ZW1wbGF0ZShwYXRoLCB0YXJnZXQsIGpzb25EYXRhKSB7XG4gICAgICAgIHZhciBzb3VyY2U7XG4gICAgICAgIHZhciB0ZW1wbGF0ZTtcbiAgICAgICAgJC5hamF4KHtcbiAgICAgICAgICAgIHVybDogcGF0aCxcbiAgICAgICAgICAgIGNhY2hlOiBmYWxzZSxcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZ1bmN0aW9uIHN1Y2Nlc3MoZGF0YSkge1xuICAgICAgICAgICAgICAgIHNvdXJjZSA9IGRhdGE7XG4gICAgICAgICAgICAgICAgdGVtcGxhdGUgPSBIYW5kbGViYXJzLmNvbXBpbGUoc291cmNlKTtcbiAgICAgICAgICAgICAgICAkKHRhcmdldCkuaHRtbCh0ZW1wbGF0ZShqc29uRGF0YSkpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGVkaXRvcjogZnVuY3Rpb24gZWRpdG9yKCkge1xuICAgICAgICAkKCcuZWRpdG9yJykucmVkYWN0b3Ioe1xuICAgICAgICAgICAgaW1hZ2VVcGxvYWQ6ICcvdXBsb2FkL2ltYWdlJyxcbiAgICAgICAgICAgIGZpbGVVcGxvYWQ6ICcvdXBsb2FkL2RvY3VtZW50JyxcbiAgICAgICAgICAgIGltYWdlTWFuYWdlckpzb246ICcvdXBsb2FkL3JlYWQnLFxuICAgICAgICAgICAgcmVwbGFjZURpdnM6IGZhbHNlLFxuICAgICAgICAgICAgYnV0dG9uU291cmNlOiB0cnVlLFxuICAgICAgICAgICAgbGFuZzogJ2VzJyxcbiAgICAgICAgICAgIHBsdWdpbnM6IFsndW5kZXJsaW5lJywgJ3ZpZGVvJywgJ2ZvbnRjb2xvcicsICdpbWFnZW1hbmFnZXInLCAndGFibGUnLCAnZm9udHNpemUnLCAnZnVsbHNjcmVlbiddLFxuICAgICAgICAgICAgZm9ybWF0dGluZzogWydwJywgJ2Jsb2NrcXVvdGUnLCAncHJlJywgJ2gxJywgJ2gyJywgJ2gzJywgJ2g0JywgJ2g1J10sXG4gICAgICAgICAgICBmb3JtYXR0aW5nQWRkOiB7XG4gICAgICAgICAgICAgICAgXCJhY2NvcmRpb24taGVhZGVyXCI6IHtcbiAgICAgICAgICAgICAgICAgICAgdGl0bGU6ICdUaXR1bG8gQWNjb3JkaW9uJyxcbiAgICAgICAgICAgICAgICAgICAgYXJnczogWydoMycsICdjbGFzcycsICdhY2NvcmRpb24tdGl0dWxvJywgJ3RvZ2dsZSddXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICB9LFxuICAgIGZpbHRlclRhYmxlOiBmdW5jdGlvbiBmaWx0ZXJUYWJsZSgpIHtcbiAgICAgICAgJCgnLnRhYmxlLWZpbHRlcicpLkRhdGFUYWJsZSh7XG4gICAgICAgICAgICBcImxhbmd1YWdlXCI6IHtcbiAgICAgICAgICAgICAgICBcImxlbmd0aE1lbnVcIjogXCJNb3N0cmFyIF9NRU5VXyByZWdpc3Ryb3MgcG9yIHDDoWdpbmFcIixcbiAgICAgICAgICAgICAgICBcInplcm9SZWNvcmRzXCI6IFwiTm8gZXhpc3RlbiByZWdpc3Ryb3NcIixcbiAgICAgICAgICAgICAgICBcImluZm9cIjogXCJNb3N0cmFuZG8gbGEgcMOhZ2luYSBfUEFHRV8gZGUgX1BBR0VTX1wiLFxuICAgICAgICAgICAgICAgIFwiaW5mb0VtcHR5XCI6IFwiTm8gaGF5IHJlZ2lzdHJvcyBkaXNwb25pYmxlc1wiLFxuICAgICAgICAgICAgICAgIFwic2VhcmNoXCI6IFwiQnVzY2FyOlwiLFxuICAgICAgICAgICAgICAgIFwiaW5mb0ZpbHRlcmVkXCI6IFwiKGNvbiBmaWx0cm8gZGUgX01BWF8gcmVnaXN0cm9zIGVuIHRvdGFsKVwiLFxuICAgICAgICAgICAgICAgIFwicGFnaW5hdGVcIjoge1xuICAgICAgICAgICAgICAgICAgICBcImZpcnN0XCI6IFwiUHJpbWVyb1wiLFxuICAgICAgICAgICAgICAgICAgICBcImxhc3RcIjogXCLDmmx0aW1vXCIsXG4gICAgICAgICAgICAgICAgICAgIFwibmV4dFwiOiBcIlNpZ3VpZW50ZVwiLFxuICAgICAgICAgICAgICAgICAgICBcInByZXZpb3VzXCI6IFwiQW50ZXJpb3JcIlxuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgfSxcbiAgICBHZW5lcmFsOiB7XG4gICAgICAgIEJhbm5lcjoge1xuICAgICAgICAgICAgdXBsb2FkOiBmdW5jdGlvbiB1cGxvYWQoKSB7XG4gICAgICAgICAgICAgICAgZXZlbnQucHJldmVudERlZmF1bHQoKTtcbiAgICAgICAgICAgICAgICBBcHAubG9hZGluZygpO1xuICAgICAgICAgICAgICAgIHZhciBmb3JtID0gdGhpcztcbiAgICAgICAgICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgICAgICAgICAgeGhyLm9ubG9hZCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHhoci5zdGF0dXMgPj0gMjAwICYmIHhoci5zdGF0dXMgPCA0MDApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBkYXRhID0gSlNPTi5wYXJzZSh4aHIucmVzcG9uc2UpO1xuICAgICAgICAgICAgICAgICAgICAgICAgQXBwLlJlbmRlcignQmFubmVycy5oYnMnLCBmdW5jdGlvbiAodGVtcGxhdGUpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2xpZGVycycpLmlubmVySFRNTCA9IHRlbXBsYXRlKGRhdGEuYmFubmVycyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGRlbGV0ZUJhbm5lciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoJy5kZWxldGUtYmFubmVyJyk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgYm5yID0gMDsgYm5yIDwgZGVsZXRlQmFubmVyLmxlbmd0aDsgYm5yKyspIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGVsZXRlQmFubmVyW2Jucl0uYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCBBcHAuR2VuZXJhbC5CYW5uZXIuZGVsZXRlLCBmYWxzZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBmb3JtLnJlc2V0KCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBBcHAubG9hZGluZ0hpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvb3Rib3guYWxlcnQoZGF0YS5tZXNzYWdlKTtcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXCJFcnJvciBkZSByZXF1ZXN0XCIpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICB4aHIub3Blbihmb3JtLm1ldGhvZCwgZm9ybS5hY3Rpb24sIHRydWUpO1xuICAgICAgICAgICAgICAgIHhoci5zZW5kKG5ldyBGb3JtRGF0YShmb3JtKSk7XG4gICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIGRlbGV0ZTogZnVuY3Rpb24gX2RlbGV0ZSgpIHtcbiAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgICAgICAgICAgIHZhciBzbGlkZSA9IHRoaXM7XG4gICAgICAgICAgICAgICAgdmFyIGlkID0gc2xpZGUuZGF0YXNldC5pZDtcbiAgICAgICAgICAgICAgICBib290Ym94LmNvbmZpcm0oe1xuICAgICAgICAgICAgICAgICAgICBzaXplOiAnc21hbGwnLFxuICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiBcIkVzdGEgc2VndXJvKGEpIGRlIGVsaW1pbmFyIGVzdGUgYmFubmVyXCIsXG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrOiBmdW5jdGlvbiBjYWxsYmFjayhyZXNwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBBcHAubG9hZGluZygpO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3ApIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcHAuZ2V0SlNPTihcIi9nZW5lcmFsL2RlbGV0ZS1iYW5uZXIvXCIgKyBpZCwgZnVuY3Rpb24gKHJlc3VsdCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocmVzdWx0LnN0YXRlKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgc2xpZGVyID0gc2xpZGUucGFyZW50Tm9kZS5wYXJlbnROb2RlLnBhcmVudE5vZGUucGFyZW50Tm9kZS5wYXJlbnROb2RlO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2xpZGVyLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQoc2xpZGVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBBcHAubG9hZGluZ0hpZGUoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYm9vdGJveC5hbGVydChyZXN1bHQubWVzc2FnZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH0sXG4gICAgUmVuZGVyOiBmdW5jdGlvbiBSZW5kZXIodHBsLCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgIHhoci5vcGVuKCdHRVQnLCBcIi9BcHAvUmVzb3VyY2UvVmlld3MvdGVtcGxhdGVzL1wiICsgdHBsLCB0cnVlKTtcbiAgICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGlmICh4aHIucmVhZHlTdGF0ZSA9PSA0ICYmIHhoci5zdGF0dXMgPT0gMjAwKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJhdyA9IHhoci5yZXNwb25zZVRleHQ7XG4gICAgICAgICAgICAgICAgdmFyIGNvbXBpbGVkID0gSGFuZGxlYmFycy5jb21waWxlKHJhdyk7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soY29tcGlsZWQpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuICAgICAgICB4aHIuc2VuZCgpO1xuICAgIH1cblxufTtcbihmdW5jdGlvbiAoJCkge1xuICAgICQuZm4ucmVwbGFjZUNsYXNzID0gZnVuY3Rpb24gKHBGcm9tQ2xhc3MsIHBUb0NsYXNzKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnJlbW92ZUNsYXNzKHBGcm9tQ2xhc3MpLmFkZENsYXNzKHBUb0NsYXNzKTtcbiAgICB9O1xufSkoalF1ZXJ5KTtcbndpbmRvdy5vbmxvYWQgPSBBcHAuaW5pdGlhbGl6ZSgpOyJdLCJmaWxlIjoibWFpbi1hZG1pbi5taW4uanMifQ==
